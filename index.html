<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFT API Access Demo</title>
    <script src="https://unpkg.com/@perawallet/connect@1.3.4/dist/index.umd.min.js"></script>
    <script src="https://unpkg.com/algosdk@2.7.0/dist/browser/algosdk.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        h1 {
            color: #333;
            margin-bottom: 8px;
            font-size: 2em;
        }

        .subtitle {
            color: #666;
            margin-bottom: 24px;
        }

        .step {
            margin: 20px 0;
            padding: 20px;
            background: #f7f7f7;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .step-number {
            display: inline-block;
            background: #667eea;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            text-align: center;
            line-height: 28px;
            font-weight: bold;
            margin-right: 12px;
        }

        .step-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 8px;
        }

        button:hover:not(:disabled) {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .status {
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
            font-size: 0.95em;
        }

        .status.info {
            background: #e3f2fd;
            color: #1976d2;
            border-left: 4px solid #1976d2;
        }

        .status.success {
            background: #e8f5e9;
            color: #2e7d32;
            border-left: 4px solid #2e7d32;
        }

        .status.error {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid #c62828;
        }

        .status.warning {
            background: #fff3e0;
            color: #ef6c00;
            border-left: 4px solid #ef6c00;
        }

        .wallet-info {
            background: #f5f5f5;
            padding: 16px;
            border-radius: 8px;
            margin-top: 12px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            word-break: break-all;
        }

        .response-box {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 16px;
            border-radius: 8px;
            margin-top: 12px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            overflow-x: auto;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }

        .hidden {
            display: none;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
            margin-left: 8px;
        }

        .badge.connected {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .badge.disconnected {
            background: #ffebee;
            color: #c62828;
        }

        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .api-endpoint {
            background: #f5f5f5;
            padding: 8px 12px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            margin-top: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- NFT Management Card -->
        <div class="card">
            <h1>üé® NFT Management</h1>
            <p class="subtitle">Create and transfer your API Access NFT</p>

            <!-- Mint NFT -->
            <div class="step">
                <div class="step-title">
                    <span class="step-number">1</span>
                    Mint Access NFT
                </div>
                <p style="color: #666; margin-bottom: 12px;">
                    Create a new NFT that grants API access. Connect wallet first.
                </p>
                <button id="mint-nft" disabled>Mint NFT</button>
                <div id="mint-status" class="hidden"></div>
            </div>

            <!-- Transfer NFT -->
            <div class="step">
                <div class="step-title">
                    <span class="step-number">2</span>
                    Transfer NFT
                </div>
                <p style="color: #666; margin-bottom: 12px;">
                    Send your NFT to another wallet to grant them API access
                </p>
                <input
                    type="text"
                    id="recipient-address"
                    placeholder="Recipient wallet address (e.g., OSOEMEN...)"
                    style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.95em; margin-bottom: 8px;"
                    disabled
                />
                <input
                    type="number"
                    id="asset-id"
                    placeholder="NFT Asset ID"
                    style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 0.95em; margin-bottom: 8px;"
                    disabled
                />
                <button id="transfer-nft" disabled>Transfer NFT</button>
                <div id="transfer-status" class="hidden"></div>
            </div>
        </div>

        <!-- Authentication Card -->
        <div class="card">
            <h1>üîê NFT API Access Control</h1>
            <p class="subtitle">Authenticate using your Algorand wallet and NFT ownership</p>

            <!-- Step 1: Connect Wallet -->
            <div class="step">
                <div class="step-title">
                    <span class="step-number">1</span>
                    Connect Wallet
                    <span id="connection-badge" class="badge disconnected">Disconnected</span>
                </div>
                <p style="color: #666; margin-bottom: 12px;">
                    Connect your Pera Wallet to prove wallet ownership
                </p>
                <button id="connect-wallet">Connect Pera Wallet</button>
                <div id="wallet-info" class="hidden"></div>
            </div>

            <!-- Step 2: Authenticate -->
            <div class="step">
                <div class="step-title">
                    <span class="step-number">2</span>
                    Authenticate & Verify NFT
                </div>
                <p style="color: #666; margin-bottom: 12px;">
                    Sign a challenge to prove ownership and verify NFT holdings
                </p>
                <button id="authenticate" disabled>Authenticate</button>
                <div id="auth-status" class="hidden"></div>
            </div>

            <!-- Step 3: Call Protected API -->
            <div class="step">
                <div class="step-title">
                    <span class="step-number">3</span>
                    Access Protected API
                </div>
                <p style="color: #666; margin-bottom: 12px;">
                    Call NFT-gated endpoint with your access token
                </p>
                <button id="call-protected" disabled>Call /api/protected</button>
                <button id="call-user-info" disabled>Call /api/user/info</button>
                <div id="api-response" class="hidden"></div>
            </div>
        </div>

        <!-- Info Card -->
        <div class="card">
            <h2 style="margin-bottom: 16px;">‚ÑπÔ∏è How It Works</h2>

            <h3 style="margin-top: 16px; margin-bottom: 8px; color: #667eea;">NFT Management Flow</h3>
            <ol style="line-height: 1.8; color: #555; padding-left: 20px;">
                <li><strong>Mint:</strong> Create an NFT (ASA) on Algorand TestNet</li>
                <li><strong>Transfer:</strong> Send the NFT to another wallet (e.g., "osoemen")</li>
                <li><strong>View:</strong> See the NFT in Pera Wallet and on the explorer</li>
            </ol>

            <h3 style="margin-top: 16px; margin-bottom: 8px; color: #667eea;">Authentication Flow</h3>
            <ol style="line-height: 1.8; color: #555; padding-left: 20px;">
                <li><strong>Connect:</strong> Link your Pera Wallet</li>
                <li><strong>Challenge:</strong> Backend generates random nonce</li>
                <li><strong>Sign:</strong> Wallet signs challenge with private key</li>
                <li><strong>Verify:</strong> Backend verifies signature + NFT ownership</li>
                <li><strong>Token:</strong> Receive JWT access token</li>
                <li><strong>Access:</strong> Use token to call protected APIs</li>
            </ol>

            <div style="margin-top: 20px; padding: 16px; background: #e8f5e9; border-radius: 8px; border-left: 4px solid #2e7d32;">
                <strong>‚úÖ Complete Flow:</strong>
                <ul style="margin-top: 8px; padding-left: 20px; color: #555;">
                    <li>You mint an NFT and send it to someone</li>
                    <li>They connect their wallet and authenticate</li>
                    <li>System verifies they own the NFT</li>
                    <li>They get API access via JWT token</li>
                    <li><strong>Transferring the NFT = transferring access!</strong></li>
                </ul>
            </div>

            <div style="margin-top: 20px; padding: 16px; background: #fff3e0; border-radius: 8px; border-left: 4px solid #ef6c00;">
                <strong>‚ö†Ô∏è Requirements:</strong>
                <ul style="margin-top: 8px; padding-left: 20px; color: #555;">
                    <li>Backend API running on http://localhost:8000 (optional for minting/transfer)</li>
                    <li>Pera Wallet browser extension installed</li>
                    <li>TestNet ALGO (get from <a href="https://bank.testnet.algorand.network/" target="_blank" style="color: #667eea;">faucet</a>)</li>
                    <li>For authentication: Update .env with NFT_ASSET_ID</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE_URL = 'http://localhost:8000';

        // Initialize Pera Wallet
        const peraWallet = new PeraWalletConnect();

        // State
        let userAddress = null;
        let accessToken = null;

        // DOM Elements
        const connectBtn = document.getElementById('connect-wallet');
        const authBtn = document.getElementById('authenticate');
        const callProtectedBtn = document.getElementById('call-protected');
        const callUserInfoBtn = document.getElementById('call-user-info');
        const mintBtn = document.getElementById('mint-nft');
        const transferBtn = document.getElementById('transfer-nft');
        const recipientInput = document.getElementById('recipient-address');
        const assetIdInput = document.getElementById('asset-id');
        const walletInfo = document.getElementById('wallet-info');
        const authStatus = document.getElementById('auth-status');
        const apiResponse = document.getElementById('api-response');
        const mintStatus = document.getElementById('mint-status');
        const transferStatus = document.getElementById('transfer-status');
        const connectionBadge = document.getElementById('connection-badge');

        // Utility functions
        function showStatus(element, message, type) {
            element.className = `status ${type}`;
            element.innerHTML = message;
            element.classList.remove('hidden');
        }

        function formatJSON(data) {
            return JSON.stringify(data, null, 2);
        }

        // Step 1: Connect Wallet
        connectBtn.addEventListener('click', async () => {
            try {
                connectBtn.innerHTML = '<span class="loader"></span>Connecting...';
                connectBtn.disabled = true;

                const accounts = await peraWallet.connect();
                userAddress = accounts[0];

                // Update UI
                walletInfo.className = 'wallet-info';
                walletInfo.innerHTML = `
                    <strong>Connected Address:</strong><br>
                    ${userAddress}
                `;

                connectionBadge.className = 'badge connected';
                connectionBadge.textContent = 'Connected';

                connectBtn.innerHTML = '‚úì Wallet Connected';
                connectBtn.style.background = '#2e7d32';
                authBtn.disabled = false;

                // Enable NFT management buttons
                mintBtn.disabled = false;
                recipientInput.disabled = false;
                assetIdInput.disabled = false;
                transferBtn.disabled = false;

                showStatus(walletInfo, '‚úÖ Wallet connected successfully', 'success');

            } catch (error) {
                console.error('Connection error:', error);
                connectBtn.innerHTML = 'Connect Pera Wallet';
                connectBtn.disabled = false;
                showStatus(walletInfo, `‚ùå Connection failed: ${error.message}`, 'error');
            }
        });

        // Step 2: Authenticate
        authBtn.addEventListener('click', async () => {
            try {
                authBtn.innerHTML = '<span class="loader"></span>Authenticating...';
                authBtn.disabled = true;

                // 1. Get challenge from backend
                showStatus(authStatus, 'üìù Requesting challenge...', 'info');

                const challengeRes = await fetch(`${API_BASE_URL}/auth/challenge`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ address: userAddress })
                });

                if (!challengeRes.ok) {
                    const error = await challengeRes.json();
                    throw new Error(error.error || 'Failed to get challenge');
                }

                const challenge = await challengeRes.json();
                console.log('Challenge received:', challenge);

                // 2. Sign challenge with wallet
                showStatus(authStatus, '‚úçÔ∏è Please sign the message in your wallet...', 'info');

                const message = new TextEncoder().encode(JSON.stringify(challenge));
                const signedData = await peraWallet.signData([{
                    data: Array.from(message),
                    message: "Prove wallet ownership for API access"
                }], userAddress);

                console.log('Signature received');

                // 3. Verify signature + NFT ownership
                showStatus(authStatus, 'üîç Verifying signature and NFT ownership...', 'info');

                const verifyRes = await fetch(`${API_BASE_URL}/auth/verify`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        address: userAddress,
                        signature: btoa(String.fromCharCode(...signedData[0])),
                        challenge: challenge
                    })
                });

                if (!verifyRes.ok) {
                    const error = await verifyRes.json();
                    throw new Error(error.error || 'Verification failed');
                }

                const result = await verifyRes.json();
                accessToken = result.access_token;

                console.log('Authentication successful');

                // Update UI
                authBtn.innerHTML = '‚úì Authenticated';
                authBtn.style.background = '#2e7d32';

                showStatus(authStatus, `
                    ‚úÖ <strong>Authentication Successful!</strong><br>
                    Access token issued (expires in ${result.expires_in}s)<br>
                    <div class="api-endpoint">Token: ${accessToken.substring(0, 40)}...</div>
                `, 'success');

                callProtectedBtn.disabled = false;
                callUserInfoBtn.disabled = false;

            } catch (error) {
                console.error('Authentication error:', error);
                authBtn.innerHTML = 'Authenticate';
                authBtn.disabled = false;
                showStatus(authStatus, `‚ùå Authentication failed: ${error.message}`, 'error');
            }
        });

        // Step 3a: Call Protected Endpoint
        callProtectedBtn.addEventListener('click', async () => {
            try {
                callProtectedBtn.innerHTML = '<span class="loader"></span>Calling API...';
                callProtectedBtn.disabled = true;

                const res = await fetch(`${API_BASE_URL}/api/protected`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                const data = await res.json();

                if (!res.ok) {
                    throw new Error(data.error || 'API call failed');
                }

                apiResponse.className = 'response-box';
                apiResponse.textContent = formatJSON(data);

                showStatus(apiResponse, '', 'success');

                callProtectedBtn.innerHTML = '‚úì Success';
                setTimeout(() => {
                    callProtectedBtn.innerHTML = 'Call /api/protected';
                    callProtectedBtn.disabled = false;
                }, 2000);

            } catch (error) {
                console.error('API error:', error);
                showStatus(apiResponse, `‚ùå API call failed: ${error.message}`, 'error');
                callProtectedBtn.innerHTML = 'Call /api/protected';
                callProtectedBtn.disabled = false;
            }
        });

        // Step 3b: Call User Info Endpoint
        callUserInfoBtn.addEventListener('click', async () => {
            try {
                callUserInfoBtn.innerHTML = '<span class="loader"></span>Fetching...';
                callUserInfoBtn.disabled = true;

                const res = await fetch(`${API_BASE_URL}/api/user/info`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                const data = await res.json();

                if (!res.ok) {
                    throw new Error(data.error || 'API call failed');
                }

                apiResponse.className = 'response-box';
                apiResponse.textContent = formatJSON(data);

                callUserInfoBtn.innerHTML = '‚úì Success';
                setTimeout(() => {
                    callUserInfoBtn.innerHTML = 'Call /api/user/info';
                    callUserInfoBtn.disabled = false;
                }, 2000);

            } catch (error) {
                console.error('API error:', error);
                showStatus(apiResponse, `‚ùå API call failed: ${error.message}`, 'error');
                callUserInfoBtn.innerHTML = 'Call /api/user/info';
                callUserInfoBtn.disabled = false;
            }
        });

        // Mint NFT
        mintBtn.addEventListener('click', async () => {
            try {
                mintBtn.innerHTML = '<span class="loader"></span>Minting...';
                mintBtn.disabled = true;

                showStatus(mintStatus, 'üé® Creating NFT transaction...', 'info');

                // Import Algorand SDK from CDN
                const algosdk = window.algosdk;
                if (!algosdk) {
                    throw new Error('Algorand SDK not loaded. Please refresh the page.');
                }

                // Connect to Algorand node
                const algodClient = new algosdk.Algodv2('', 'https://testnet-api.algonode.cloud', '');
                const params = await algodClient.getTransactionParams().do();

                // Create NFT configuration
                const txn = algosdk.makeAssetCreateTxnWithSuggestedParamsFromObject({
                    from: userAddress,
                    total: 1,
                    decimals: 0,
                    assetName: 'API Access Pass',
                    unitName: 'APIKEY',
                    assetURL: 'https://api.example.com/nft-metadata.json',
                    manager: userAddress,
                    reserve: userAddress,
                    freeze: userAddress,
                    clawback: userAddress,
                    defaultFrozen: false,
                    suggestedParams: params
                });

                // Encode transaction
                const txnGroup = [{ txn: txn, signers: [userAddress] }];

                showStatus(mintStatus, '‚úçÔ∏è Please sign the transaction in your wallet...', 'info');

                // Sign with Pera Wallet
                const signedTxns = await peraWallet.signTransaction([txnGroup]);

                showStatus(mintStatus, 'üì° Sending transaction to network...', 'info');

                // Send transaction
                const { txId } = await algodClient.sendRawTransaction(signedTxns).do();

                showStatus(mintStatus, '‚è≥ Waiting for confirmation...', 'info');

                // Wait for confirmation
                const confirmedTxn = await algosdk.waitForConfirmation(algodClient, txId, 4);

                const assetId = confirmedTxn['asset-index'];

                // Update UI
                mintBtn.innerHTML = '‚úì NFT Minted!';
                mintBtn.style.background = '#2e7d32';

                showStatus(mintStatus, `
                    ‚úÖ <strong>NFT Created Successfully!</strong><br>
                    <strong>Asset ID:</strong> ${assetId}<br>
                    <strong>Transaction ID:</strong> ${txId}<br>
                    <div class="api-endpoint">
                        View on explorer: <a href="https://testnet.explorer.perawallet.app/asset/${assetId}" target="_blank" style="color: #667eea;">Click here</a>
                    </div>
                    <br>
                    Add this to your .env: <code>NFT_ASSET_ID=${assetId}</code>
                `, 'success');

                // Pre-fill asset ID in transfer input
                assetIdInput.value = assetId;

            } catch (error) {
                console.error('Minting error:', error);
                mintBtn.innerHTML = 'Mint NFT';
                mintBtn.disabled = false;
                showStatus(mintStatus, `‚ùå Minting failed: ${error.message}`, 'error');
            }
        });

        // Transfer NFT
        transferBtn.addEventListener('click', async () => {
            try {
                const recipient = recipientInput.value.trim();
                const assetId = parseInt(assetIdInput.value);

                // Validate inputs
                if (!recipient) {
                    showStatus(transferStatus, '‚ùå Please enter recipient address', 'error');
                    return;
                }

                if (!assetId || assetId <= 0) {
                    showStatus(transferStatus, '‚ùå Please enter valid asset ID', 'error');
                    return;
                }

                transferBtn.innerHTML = '<span class="loader"></span>Transferring...';
                transferBtn.disabled = true;

                showStatus(transferStatus, 'üì¶ Creating transfer transaction...', 'info');

                // Import Algorand SDK
                const algosdk = window.algosdk;
                if (!algosdk) {
                    throw new Error('Algorand SDK not loaded');
                }

                // Connect to Algorand
                const algodClient = new algosdk.Algodv2('', 'https://testnet-api.algonode.cloud', '');
                const params = await algodClient.getTransactionParams().do();

                // Create asset transfer transaction
                const txn = algosdk.makeAssetTransferTxnWithSuggestedParamsFromObject({
                    from: userAddress,
                    to: recipient,
                    amount: 1,
                    assetIndex: assetId,
                    suggestedParams: params
                });

                const txnGroup = [{ txn: txn, signers: [userAddress] }];

                showStatus(transferStatus, '‚úçÔ∏è Please sign the transaction in your wallet...', 'info');

                // Sign transaction
                const signedTxns = await peraWallet.signTransaction([txnGroup]);

                showStatus(transferStatus, 'üì° Sending transaction...', 'info');

                // Send transaction
                const { txId } = await algodClient.sendRawTransaction(signedTxns).do();

                showStatus(transferStatus, '‚è≥ Waiting for confirmation...', 'info');

                // Wait for confirmation
                await algosdk.waitForConfirmation(algodClient, txId, 4);

                // Update UI
                transferBtn.innerHTML = '‚úì Transferred!';
                transferBtn.style.background = '#2e7d32';

                showStatus(transferStatus, `
                    ‚úÖ <strong>NFT Transferred Successfully!</strong><br>
                    <strong>To:</strong> ${recipient}<br>
                    <strong>Asset ID:</strong> ${assetId}<br>
                    <strong>Transaction ID:</strong> ${txId}<br>
                    <div class="api-endpoint">
                        View on explorer: <a href="https://testnet.explorer.perawallet.app/tx/${txId}" target="_blank" style="color: #667eea;">Click here</a>
                    </div>
                    <br>
                    <strong>Note:</strong> The recipient now has API access!
                `, 'success');

                // Reset button after delay
                setTimeout(() => {
                    transferBtn.innerHTML = 'Transfer NFT';
                    transferBtn.style.background = '#667eea';
                    transferBtn.disabled = false;
                }, 3000);

            } catch (error) {
                console.error('Transfer error:', error);
                transferBtn.innerHTML = 'Transfer NFT';
                transferBtn.disabled = false;
                showStatus(transferStatus, `‚ùå Transfer failed: ${error.message}`, 'error');
            }
        });

        // Check for existing session on load
        window.addEventListener('load', async () => {
            try {
                // Reconnect to accounts if previously connected
                const accounts = await peraWallet.reconnectSession();
                if (accounts.length) {
                    userAddress = accounts[0];
                    walletInfo.className = 'wallet-info';
                    walletInfo.innerHTML = `
                        <strong>Reconnected Address:</strong><br>
                        ${userAddress}
                    `;
                    connectionBadge.className = 'badge connected';
                    connectionBadge.textContent = 'Connected';
                    connectBtn.innerHTML = '‚úì Wallet Connected';
                    connectBtn.style.background = '#2e7d32';
                    authBtn.disabled = false;

                    // Enable NFT management buttons
                    mintBtn.disabled = false;
                    recipientInput.disabled = false;
                    assetIdInput.disabled = false;
                    transferBtn.disabled = false;

                    console.log('Session reconnected:', userAddress);
                }
            } catch (error) {
                console.log('No existing session');
            }
        });
    </script>
</body>
</html>
